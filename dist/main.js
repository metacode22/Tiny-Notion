(()=>{"use strict";const t=({element:t,$target:e,className:n="",id:s="",content:a="",attributes:i})=>{const o=document.createElement(t);return o.textContent=a,n&&(o.className=n),s&&(o.id=s),e&&e.appendChild(o),i&&Object.entries(i).forEach((([t,e])=>{o.setAttribute(t,e)})),o},e="route-change",n=t=>{window.dispatchEvent(new CustomEvent(e,{detail:{nextUrl:t,action:"historyPush"}}))};function s({$target:e,initialState:s}){const a=t({element:"header",$target:e,content:s||""});"NAV"===e.tagName&&a.classList.add("sidebar-header"),this.state=s,this.setState=t=>{this.state=t,this.render()},this.render=()=>{a.innerHTML=`\n\t\t\t${this.state}\n\t\t`},this.init=()=>{"NAV"===e.tagName&&a.addEventListener("click",(()=>{n("/")}))},this.init()}function a({$target:e}){const n=t({element:"div",$target:e,className:"not-found"});this.render=()=>{n.innerHTML="\n      <h1>문서를 선택해주세요.</h1>\n    "}}const i=async({url:t="",options:e={}})=>{try{const n=await fetch(`https://kdt-frontend.programmers.co.kr/documents/${t}`,{...e,headers:{"Content-Type":"application/json","x-username":"jun"}});if(n.ok)return await n.json();throw new Error("API 요청 중 에러가 발생했습니다.")}catch(t){console.log(t.message)}},o=async()=>await i({options:{method:"get"}}),c=async({title:t="제목 없음",parent:e=null})=>await i({options:{method:"post",body:JSON.stringify({title:t,parent:e})}}),r=async(t,{title:e,content:n})=>await i({url:t,options:{method:"put",body:JSON.stringify({title:e,content:n})}}),d=t=>{const e=new URLSearchParams(window.location.search).get("currentPath").split(" >");return e[e.length-1]=t,`${e.join(" > ")}`},l=(t,e)=>{let n;return()=>{n&&clearTimeout(n),n=setTimeout((()=>{t()}),e)}},u={heading1:{trigger:"# ",tagName:"h1",offset:2},heading2:{trigger:"## ",tagName:"h2",offset:3},heading3:{trigger:"### ",tagName:"h3",offset:4}},m="caret",h=(e,n,s)=>{if("DIV"===s.tagName)for(const o in u){const{trigger:c,tagName:r,offset:d}=u[o],{textContent:l}=n;if(0===l.indexOf(c)){a(e);const o=t({element:r,content:l.substring(d)});s.replaceChild(o,n),i(e)}}function a(e){const n=t({element:"span",id:m});window.getSelection().getRangeAt(0).insertNode(n),e.blur()}function i(t){t.focus();const e=document.createRange(),n=document.getElementById(m);e.selectNode(n);const s=window.getSelection();s.removeAllRanges(),s.addRange(e),e.deleteContents()}},g=250;function $({$target:e,initialState:n,onChangeTitleAndCurrentPath:s}){const a=t({element:"div",$target:e,className:"editor"}),i=t({element:"input",$target:a,className:"editor-title",attributes:{type:"text",name:"title",placeholder:"제목을 입력해주세요."}}),o=t({element:"div",$target:a,className:"editor-content",attributes:{contentEditable:!0,name:"content"}});this.state=n,this.setState=t=>{this.state=t,this.render()},this.render=()=>{const{title:t,content:e}=this.state;i.value=t,o.innerHTML=e},this.focus=()=>{i.focus()},i.addEventListener("input",l((async()=>{const t=i.value,{id:e}=this.state,n=d(t);await r(e,{title:t}),s(e,n)}),g)),o.addEventListener("input",l((async()=>{await r(this.state.id,{content:o.innerHTML})}),g)),o.addEventListener("input",(t=>{const e=window.getSelection().anchorNode,n=e.parentNode;h(o,e,n)}))}const p=window.localStorage,v="openedDocumentItems",w=(t,e)=>{try{return JSON.parse(p.getItem(t))||e}catch(t){return console.log(t.message),e}},S=(t,e)=>{try{p.setItem(t,JSON.stringify(e))}catch{console.log(error.message)}};function y({$target:e,initialState:s}){const a=t({element:"div",$target:e,className:"sub-documents"});this.state=s,this.setState=t=>{this.state=t,this.render()},this.render=()=>{const{subDocumentList:t}=this.state,{currentPath:e}=this.state;a.innerHTML=`\n      ${t.map((({id:t,title:n})=>`\n        <div class='document-item' title='${n}' data-current-path='${e} > ${n}' data-id='${t}'>\n          <div class='document-item__title'>${n}</div>\n        </div>\n      `)).join("")}\n    `},a.addEventListener("click",(t=>{t.stopPropagation();const{target:e}=t,{id:s,currentPath:a}=e.closest("[data-id]").dataset,i=w(v,[]);i.includes(this.state.id)||S(v,[...i,this.state.id]),n(`/documents/${s}?currentPath=${a}`)}))}function f({$target:e,initialState:n,onChangeTitle:i}){const o=t({element:"article",$target:e});this.state=n,this.setState=t=>{this.state=t;const{id:e,currentPath:n,subDocuments:s}=this.state;c.setState(n),d.setState({...d.state,id:e,currentPath:n,subDocumentList:s}),e?(document.querySelector(".editor").style.display="flex",document.querySelector(".not-found").style.display="none",r.setState({...this.state})):(document.querySelector(".editor").style.display="none",document.querySelector(".not-found").style.display="block",l.render())},this.focus=()=>{r.focus()};const c=new s({$target:o}),r=new $({$target:o,initialState:this.state,onChangeTitleAndCurrentPath:(t,e)=>{c.setState(e),i(t,e)}}),d=new y({$target:o,initialState:this.state?.subDocuments}),l=new a({$target:o})}const D={rootDocumentListItem:(t,e,n,s)=>{const a=s.includes(String(t)),[,,i]=window.location.pathname.split("/");return`\n        <div class='document-item-container' title='${e}'>\n          <div data-id='${t}' data-current-path='${e}' class='document-item ${String(t)===i?"selected":""}'>\n            <img data-action='toggle' src='/src/assets/images/toggleButton.svg' class='${a?"toggled":"not-toggled"}'>\n            <div class='document-item__title'>${e}</div>\n            <div class='document-item__buttons'>\n              <img data-action='delete' src='/src/assets/images/deleteButton.svg'>\n              <img data-action='add' src='/src/assets/images/addButton.svg'>\n            </div>\n          </div>\n          ${a?C([e],n,s):""}\n          ${a&&!n.length?'<div class="no-sub-document">하위 페이지가 존재하지 않습니다.</div>':""}\n        </div>\n      `}},C=(t,e,n)=>`\n    <ul class='document-list'>\n      ${e.map((({id:e,title:s,documents:a})=>{const i=n.includes(String(e)),[,,o]=window.location.pathname.split("/"),c=String(e)===o;return`\n            <div class='document-item-container' title='${s}'>\n              <div data-id='${e}' data-current-path='${t.join(" > ")} > ${s}' class='document-item ${c?"selected":""}'>\n                <img data-action='toggle' src='/src/assets/images/toggleButton.svg' class='${i?"toggled":"not-toggled"}'>\n                <div class='document-item__title'>${s}</div>\n                <div class='document-item__buttons'>\n                  <img data-action='delete' src='/src/assets/images/deleteButton.svg'>\n                  <img data-action='add' src='/src/assets/images/addButton.svg'>\n                </div>\n              </div>\n              ${i?C([...t,s],a,n):""}\n              ${i&&!a.length?'<div class="no-sub-document">하위 페이지가 존재하지 않습니다.</div>':""}\n            </div>\n          `})).join("")}\n    </ul>\n  `,b=D;function N({$target:e,initialState:s=[],onClickDocumentItemAddButton:a,onClickDocumentItemDeleteButton:i,onClickDocumentItemToggleButton:o}){const c=t({element:"div",$target:e,className:"document-list__root"});this.state=s,this.setState=t=>{this.state=t,this.render()},this.render=()=>{const t=w(v,[]);c.innerHTML=`\n\t\t\t${this.state.map((({id:e,title:n,documents:s})=>`\n\t\t\t\t${b.rootDocumentListItem(e,n,s,t)}\n\t\t\t`)).join("")}\n\t\t`},this.render(),c.addEventListener("click",(async t=>{t.stopPropagation();const{target:e}=t;if(["document-list","document-list__root","document-item-container","no-sub-document"].includes(e.className))return;const{action:s}=e.dataset,{id:c,currentPath:r}=e.closest("[data-id]").dataset;if(s)switch(s){case"add":a(c,r);break;case"delete":i(c);break;case"toggle":o(c)}!s&&c&&n(`/documents/${c}?currentPath=${r}`)}))}function k({$target:e,onClickRootAddButton:n}){const s=t({element:"div",$target:e,className:"root-document-add-button"});this.render=()=>{s.innerHTML="\n\t\t\t<img data-action='add' src='/src/assets/images/addButton.svg'>\n\t\t\t<div>새 문서 만들기 s3 Test</div>\n\t\t"},this.render(),s.addEventListener("click",(()=>{n()}))}function L({$target:e,initialState:n,onClickRootAddButton:a,onClickDocumentItemAddButton:i,onClickDocumentItemDeleteButton:o,onClickDocumentItemToggleButton:c}){const r=t({element:"nav",$target:e}),d=(new s({$target:r,initialState:"Metamong"}),new N({$target:r,onClickDocumentItemAddButton:i,onClickDocumentItemDeleteButton:o,onClickDocumentItemToggleButton:c}));new k({$target:r,onClickRootAddButton:a}),this.state=n,this.setState=t=>{this.state=t,d.setState(this.state)}}new function({$target:s,initialState:a}){const r=t({element:"main",$target:s});this.state=a,this.setState=t=>{this.state=t,d.setState(this.state.rootDocuments)},this.route=async()=>{const{pathname:t,search:e}=window.location,[,,n]=t.split("/"),s=new URLSearchParams(e);try{if(n){const{title:t,content:e,documents:a}=await(async t=>await i({url:t,options:{method:"get"}}))(n);l.focus(),l.setState({id:n,currentPath:s.get("currentPath"),title:t,content:e,subDocuments:a})}else l.setState({...l.state,id:void 0,currentPath:"Metamong",subDocuments:[]});this.setState({...this.state})}catch(t){history.replaceState(null,null,"/"),l.setState({...l.state,id:void 0,currentPath:"Metamong",subDocuments:[]})}finally{document.querySelector(".selected")?.classList.remove("selected"),document.querySelector(`[data-id='${n}']`)?document.querySelector(`[data-id='${n}']`).classList.add("selected"):document.querySelector("header").classList.add("selected")}},this.init=async()=>{const t=await o();this.setState({...this.state,rootDocuments:t}),this.route()};const d=new L({$target:r,onClickRootAddButton:async()=>{const t=await c({title:"제목 없음"}),e=await o();this.setState({...this.state,rootDocuments:e}),n(`/documents/${t.id}?currentPath=${t.title}`)},onClickDocumentItemAddButton:async(t,e)=>{const s=w(v,[]);s.includes(t)||S(v,[...s,t]);const a=await c({parent:t}),i=await o();this.setState({...this.state,rootDocuments:i}),n(`/documents/${a.id}?currentPath=${e} > ${a.title}`)},onClickDocumentItemDeleteButton:async t=>{if(!confirm("해당 문서를 삭제하시겠습니까?"))return;const e=w(v,[]),[,,s]=window.location.pathname.split("/"),a=e.findIndex((e=>e===t));-1!==a&&e.splice(a,1),S(v,[...e]),await(async t=>await i({url:t,options:{method:"delete"}}))(t);const c=await o();this.setState({...this.state,rootDocuments:c}),t===s&&n("/")},onClickDocumentItemToggleButton:t=>{const e=w(v,[]);if(e.includes(t)){const n=e.findIndex((e=>e===t));-1!==n&&e.splice(n,1),S(v,[...e])}else S(v,[...e,t]);this.setState({...this.state})}}),l=new f({$target:r,initialState:a,onChangeTitle:async(t,n)=>{const s=await o();var a;this.setState({...this.state,rootDocuments:s}),a=`/documents/${t}?currentPath=${n}`,window.dispatchEvent(new CustomEvent(e,{detail:{nextUrl:a,action:"historyReplace"}}))}});var u;this.init(),u=async()=>{this.route()},window.addEventListener(e,(t=>{const{nextUrl:e,action:n}=t.detail;e&&"historyPush"===n&&(history.pushState(null,null,e),u()),e&&"historyReplace"===n&&history.replaceState(null,null,e)})),window.addEventListener("popstate",(()=>{u()}))}({$target:document.getElementById("root")})})();